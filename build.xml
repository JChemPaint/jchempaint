<project name="JCPCDK" default="dist" basedir=".">
    
    <property file="ant.properties"/>

    <property name="jcp.version" value="3.3-1207" />
    <property name="debug" value="on" />
    <property name="deprecation" value="on" />
    <property name="optimization" value="off" />

    <property name="cdk.dir" value="/home/ralf/remote/CDK" />
    <property name="cdk.dist" value="${cdk.dir}/dist" />
    <property name="cdk.lib" value="${cdk.dir}/jar" />
    <property name="cdk.devellib" value="${cdk.dir}/develjar" />
    <property name="cdk.metainf" value="${cdk.dir}/src/META-INF" />
    <property name="src" value="src" />
    <property name="lib" value="lib" />
    <property name="javadoc.dir" value="javadoc" />
    <property name="devellib" value="libdevel" />
    <property name="dist" value="dist" />
    <property name="dist-classes" value="${dist}/classes" />
    <property name="dist-test" value="${dist}/test" />
    <property name="metainf" value="META-INF" />
    <property name="po" value="po" />
    <property name="po-classes" value="po/classes" />

    <property name="growing_list_file" value="${dist}/applet-classes-list.files"/>
    <property name="growing_classpath" value="${dist}/applet-jars-list.files"/>
    
    <taskdef resource="net/sf/antcontrib/antcontrib.properties">
      <classpath>
        <pathelement location="${devellib}/ant-contrib-0.6.jar"/>
      </classpath>
    </taskdef>
    

    <taskdef resource="net/sf/antcontrib/antcontrib.properties">
      <classpath>
        <pathelement location="libdevel/ant-contrib-0.6.jar"/>
      </classpath>
    </taskdef>

    <target id="clean" name="clean" description="Removes compiled stuff.">
        <delete dir="${dist}" />
        <delete dir="${javadoc.dir}" />
    </target>

    <target id="dist" name="dist" depends="compile-jcp, unjar-libjars, unjar-cdkjars"
            description="Builds the JChemPaint application">
        <jar jarfile="${dist}/jchempaint-${jcp.version}.jar">
            <manifest>
                <attribute name="Main-Class" value="org.openscience.jchempaint.application.JChemPaint"/>
                <section name="org/openscience/jchempaint/">
                    <attribute name="Specification-Title" value="JChemPaint"/>
                    <attribute name="Specification-Version" value="2.2"/>
                    <attribute name="Specification-Vendor" value="The CDK Project"/>
                    <attribute name="Implementation-Title" value="org.openscience.cdk.applications.jchempaint"/>
                    <attribute name="Implementation-Version" value="${jcp.version}"/>
                    <attribute name="Implementation-Vendor" value="The CDK Project"/>
                </section>
            </manifest>
            <fileset dir="${dist-classes}">
                <include name="**/*" />
            </fileset>
            <fileset dir="${cdk.dir}/doc">
                <include name="lgpl.license" />
            </fileset>          
            <fileset dir=".">
                <include name="lib-licenses.txt" />
            </fileset>          
        </jar>
    </target>
   <!-- Without any dependencies, to be used as maven artifact -->	
   <target id="nodeps" name="nodeps" depends="compile-jcp, unjar-libjars, unjar-cdkjars"
            description="Builds the JChemPaint application">
        <jar jarfile="${dist}/jchempaint-nodeps-${jcp.version}.jar">
            <manifest>
                <attribute name="Main-Class" value="org.openscience.jchempaint.application.JChemPaint"/>
                <section name="org/openscience/jchempaint/">
                    <attribute name="Specification-Title" value="JChemPaint"/>
                    <attribute name="Specification-Version" value="2.2"/>
                    <attribute name="Specification-Vendor" value="The CDK Project"/>
                    <attribute name="Implementation-Title" value="org.openscience.cdk.applications.jchempaint"/>
                    <attribute name="Implementation-Version" value="${jcp.version}"/>
                    <attribute name="Implementation-Vendor" value="The CDK Project"/>
                </section>
            </manifest>
            <fileset dir="${dist-classes}">
		<include name="org/openscience/jchempaint/**" /> 
            </fileset>
        </jar>
    </target>

    <target id="unjar-libjars" name="unjar-libjars">
        <unjar dest="${dist-classes}">
            <fileset dir="${cdk.lib}">
                <includesfile name="${cdk.metainf}/builder3d.libdepends"/>
                <includesfile name="${cdk.metainf}/builder3dtools.libdepends"/>
                <includesfile name="${cdk.metainf}/charges.libdepends"/>
                <includesfile name="${cdk.metainf}/control.libdepends"/>
                <includesfile name="${cdk.metainf}/data.libdepends"/>
                <includesfile name="${cdk.metainf}/datadebug.libdepends"/>
                <includesfile name="${cdk.metainf}/dict.libdepends"/>
                <includesfile name="${cdk.metainf}/diff.libdepends"/>
                <includesfile name="${cdk.metainf}/extra.libdepends"/>
                <includesfile name="${cdk.metainf}/forcefield.libdepends"/>
                <includesfile name="${cdk.metainf}/formula.libdepends"/>
                <!--includesfile name="${cdk.metainf}/inchi.libdepends"/-->
                <includesfile name="${cdk.metainf}/interfaces.libdepends"/>
                <includesfile name="${cdk.metainf}/io.libdepends"/>
                <includesfile name="${cdk.metainf}/isomorphism.libdepends"/>
                <includesfile name="${cdk.metainf}/libiocml.libdepends"/>
                <includesfile name="${cdk.metainf}/libiomd.libdepends"/>
                <includesfile name="${cdk.metainf}/pcore.libdepends"/>
                <includesfile name="${cdk.metainf}/pdb.libdepends"/>
                <includesfile name="${cdk.metainf}/pdbcml.libdepends"/>
                <includesfile name="${cdk.metainf}/qm.libdepends"/>
                <includesfile name="${cdk.metainf}/qsar.libdepends"/>
                <includesfile name="${cdk.metainf}/qsaratomic.libdepends"/>
                <includesfile name="${cdk.metainf}/qsarbond.libdepends"/>
                <includesfile name="${cdk.metainf}/qsarcml.libdepends"/>
                <includesfile name="${cdk.metainf}/qsarmolecular.libdepends"/>
                <includesfile name="${cdk.metainf}/qsarprotein.libdepends"/>
                <includesfile name="${cdk.metainf}/reaction.libdepends"/>
                <includesfile name="${cdk.metainf}/render.libdepends"/>
                <includesfile name="${cdk.metainf}/sdg.libdepends"/>
                <includesfile name="${cdk.metainf}/smarts.libdepends"/>
                <includesfile name="${cdk.metainf}/smiles.libdepends"/>
                <includesfile name="${cdk.metainf}/standard.libdepends"/>
                <includesfile name="${cdk.metainf}/valencycheck.libdepends"/>
            </fileset>
        </unjar>
        <unjar dest="${dist-classes}">
            <fileset dir="${lib}">
                <include name="**/*" />
            </fileset>
        </unjar>
        <delete dir="${dist-classes}/META-INF" />
     </target>

    <target id="unjar-cdkjars" name="unjar-cdkjars">
     <unjar dest="${dist-classes}">
            <fileset dir="${cdk.dist}/jar">
                <include name="cdk-annotation.jar"/>
                <include name="cdk-atomtype.jar"/>
                <!--include name="cdk-builder3d.jar"/>
                <include name="cdk-builder3dtools.jar"/-->
                <!--include name="cdk-charges.jar"/>
                <include name="cdk-control.jar"/-->
                <include name="cdk-core.jar"/>
                <include name="cdk-log4j.jar"/>
                <!--include name="cdk-datadebug.jar"/-->
                <include name="cdk-data.jar"/>
                <include name="cdk-dict.jar"/>
                <!--include name="cdk-diff.jar"/-->
                <include name="cdk-extra.jar"/>
                <!--include name="cdk-fingerprint.jar"/-->
                <!--include name="cdk-forcefield.jar"/-->
                <include name="cdk-formula.jar"/>
                <include name="cdk-inchi.jar"/>
                <include name="cdk-interfaces.jar"/>
                <include name="cdk-io.jar"/>
                <include name="cdk-ioformats.jar"/>
                <!--include name="cdk-ionpot.jar"/-->
                <include name="cdk-isomorphism.jar"/>
                <include name="cdk-libiocml.jar"/>
                <!--include name="cdk-libiomd.jar"/-->
                <!--include name="cdk-pcore.jar"/>
                <include name="cdk-pdbcml.jar"/>
                <include name="cdk-pdb.jar"/-->
                <include name="cdk-qm.jar"/>
                <!--include name="cdk-qsaratomic.jar"/>
                <include name="cdk-qsarbond.jar"/>
                <include name="cdk-qsarionpot.jar"/>
                <include name="cdk-qsar.jar"/>
                <include name="cdk-qsarmolecular.jar"/>
                <include name="cdk-qsarprotein.jar"/-->
                <include name="cdk-reaction.jar"/>
                <!--include name="cdk-render.jar"/-->
                <include name="cdk-sdg.jar"/>
                <!--include name="cdk-smarts.jar"/-->
                <include name="cdk-smiles.jar"/>
                <include name="cdk-standard.jar"/>
                <!--include name="cdk-controlbasic.jar"/>
                <include name="cdk-structgen.jar"/-->
                <include name="cdk-valencycheck.jar"/>
                
            </fileset>
        </unjar>
        <delete dir="${dist-classes}/META-INF" />
        <!--delete dir="${dist-classes}/org/openscience/cdk/renderer" /-->
        <delete dir="${dist-classes}/org/openscience/cdk/controller" />
        <delete>
           <fileset dir="${dist-classes}" includes="*" excludes="io-formats.set"/>
        </delete>
        <delete dir="${dist-classes}/org/omegahat" />
        <delete dir="${dist-classes}/org/openscience/cdk/modeling" />
        <delete dir="${dist-classes}/org/openscience/cdk/fingerprint" />
        <delete dir="${dist-classes}/org/openscience/cdk/io/cml/data" />
    </target>

    <target id="build-pot-pos" name="build-pot-pos" >
        <exec dir="." executable="xgettext">
           <arg line="-kGT._ -o po/keys.pot $$(find src/main -name &quot;*.java&quot;)"/>
        </exec>
        <foreach target="msgmerge" param="file">
           <fileset dir="po" casesensitive="yes">
             <include name="**/*.po"/>
           </fileset>
        </foreach>
    </target>
        
    <target id="msgmerge" name="msgmerge">
        <exec dir="." executable="msgmerge">
            <arg line="-U ${file} po/keys.pot"/>
        </exec>
    </target>

    <target id="msgfmt" name="msgfmt">
        <mkdir dir="po/classes" />
        <propertyregex property="filename"
                  input="${file}"
                  regexp="[.]*/po/([^\.]*)\.po"
                  select="\1"
                  casesensitive="false" />
        <exec dir="." executable="msgfmt">
            <arg line="--java2 -d po/classes -r app.i18n.Messages -l ${filename} po/${filename}.po"/>
        </exec>
    </target>

    <target id="build-languageclasses" name="build-languageclasses" unless="i18n.uptodate">
        <echo message="Compiling po files." />
        <foreach target="msgfmt" param="file">
          <path>
            <fileset dir="po" casesensitive="yes">
              <include name="**/*.po"/>
            </fileset>
          </path>
        </foreach>
    </target>

    <target id="check-languageclasses" name="check-languageclasses">
      <condition property="i18n.uptodate">
        <uptodate>
          <srcfiles dir="${po}" includes="**/*.po"/>
          <mapper type="glob" from="*.po" to="classes/app/i18n/Messages_*.class"/>
        </uptodate>
      </condition>
    </target>

    <target id="compile-jcp" name="compile-jcp" depends="check-languageclasses, build-languageclasses, makelicenseinfo" >
        <!-- TODO check if dist-all in cdk has been done-->
        <echo message="Compiling JChemPaint classes." />
        <mkdir dir="${dist-classes}" />
        <javac srcdir="${src}/main" destdir="${dist-classes}" optimize="${optimization}"
                nowarn="${nowarn}"
                debug="${debug}" deprecation="${deprecation}" target="1.5" source="1.5">
            <classpath>
                <fileset dir="${cdk.lib}" >
                </fileset>
                <fileset dir="${cdk.devellib}">
                </fileset>
                <fileset dir="${cdk.dist}/jar">
                </fileset>
                <fileset dir="${lib}">
                </fileset>
            </classpath>

         </javac>
        <copy file="lib-licenses.txt" todir="${src}/main/org/openscience/jchempaint/resources/userhelp_jcp"/>
        <copy file="${cdk.dir}/doc/lgpl.license" todir="${src}/main/org/openscience/jchempaint/resources/userhelp_jcp"/>
        <copydir dest="${dist-classes}/org/openscience/jchempaint/resources" src="${src}/main/org/openscience/jchempaint/resources"></copydir>
        <replace file="${dist-classes}/org/openscience/jchempaint/resources/JChemPaintResources.properties" token="@@@" value="${jcp.version}"/>
        <replace file="${dist-classes}/org/openscience/jchempaint/resources/userhelp_jcp/license.html" token="@@@" value="${jcp.version}"/>
        <copydir dest="${dist-classes}/org/openscience/jchempaint/dialog/templates" src="${src}/main/org/openscience/jchempaint/dialog/templates"></copydir>
        <delete file="${dist-classes}/org/openscience/jchempaint/dialog/templates/DummyClass.java"></delete>
        <copy todir="${dist-classes}">
            <fileset dir="${po-classes}"/>
        </copy>
    </target>



    <target name="dist-applet-shrunk-signed" depends="build-applet">
      <taskdef name="yguard" classname="com.yworks.yguard.YGuardTask" classpath="yguard.jar"/>

       <mkdir dir="${dist}/jar/shrinkout"/>


      <!-- shrink jcp editor file-->
       <yguard>
         <inoutpair in="${dist}/jar/jchempaint-applet-editor.jar" out="${dist}/jar/shrinkout/jchempaint-applet-editor.jar"/>
         <externalclasses>
             <fileset dir="${dist}/jar">
                <include name="**/*.jar"/>
             </fileset>
         </externalclasses>

         <shrink logfile="shrinklog.editor.xml">
             <entrypointjar name="${dist}/jar/jchempaint-applet-core.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-editor.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-org_openscience_cdk.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-org_openscience.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-org_openscience_cdk_config.jar"/>
             <property name="error-checking" value="pedantic"/>
         </shrink>
      </yguard>

       <!-- shrink jcp core file -->
       <yguard>
         <inoutpair in="${dist}/jar/jchempaint-applet-core.jar" out="${dist}/jar/shrinkout/jchempaint-applet-core.jar"/>
         <externalclasses>
             <fileset dir="${dist}/jar">
                <include name="**/*.jar"/>
             </fileset>
         </externalclasses>
         <shrink logfile="shrinklog.core.xml">
             <entrypointjar name="${dist}/jar/jchempaint-applet-editor.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-org_openscience_cdk.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-org_openscience_cdk_io.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-org_openscience.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-org_openscience_cdk_config.jar"/>
             <property name="error-checking" value="pedantic"/>

             <keep>
                <class classes="public">
                 <patternset>
                   <include name="org.openscience.jchempaint.undoredo.**.*"/>
                </patternset>
                </class>
                <class name="org.openscience.cdk.tools.LoggingTool" methods="public" fields="none" />
                <class name="org.openscience.cdk.tools.ILoggingTool" methods="public" fields="none" />
                <class name="org.openscience.cdk.interfaces.IChemObjectBuilder" methods="public" fields="none" />
                <class name="org.openscience.cdk.interfaces.IAtomContainer"   methods="public" fields="none" />
                <class name="org.openscience.cdk.controller.IControllerModel" methods="public" fields="none" />
                <class name="org.openscience.cdk.controller.IChemModelRelay" methods="public" fields="none" />
                <class name="org.openscience.cdk.tools.manipulator.AtomContainerManipulator" methods="public" fields="none" />
                <class name="org.openscience.jchempaint.JChemPaintPanel$1" methods="public" fields="none" />
                <class name="org.openscience.cdk.tools.manipulator.ChemModelManipulator" methods="public" fields="none" />
                <class name="org.openscience.cdk.renderer.selection.MultiSelection" methods="public" fields="none" />
                <class name="org.openscience.cdk.tools.manipulator.BondManipulator" methods="public" fields="none" />
                <class name="org.openscience.cdk.interfaces.IBond" methods="public" fields="none" />
                <class name="org.openscience.jchempaint.applet.JChemPaintAbstractApplet" methods="public" fields="none" />
                <class name="org.openscience.jchempaint.applet.JChemPaintViewerApplet"   methods="public" fields="none" />
                <class name="org.openscience.jchempaint.applet.JChemPaintEditorApplet"   methods="public" fields="none" />
                <class name="org.openscience.cdk.io.formats.RGroupQueryFormat"  methods="public" fields="none" />
             </keep>
         </shrink>
      </yguard>

       <!-- shrink CDK jar -->
       <yguard>
         <inoutpair in="${dist}/jar/jchempaint-applet-org_openscience_cdk.jar" out="${dist}/jar/shrinkout/jchempaint-applet-org_openscience_cdk.jar"/>
         <externalclasses>
             <fileset dir="${dist}/jar">
                <include name="**/*.jar"/>
                <exclude name="**/jchempaint-applet-org_openscience_cdk.jar"/>
             </fileset>
         </externalclasses>
         <shrink logfile="shrinklog.cdk.xml">
             <entrypointjar name="${dist}/jar/jchempaint-applet-core.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-editor.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-org_openscience.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-org_openscience_cdk_config.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-org_openscience_cdk_controller.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-org_openscience_cdk_io_cml.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-org_xmlcml.jar"/>
             <property name="error-checking" value="pedantic"/>
             <keep>
               <class classes="public">
               <patternset>
                <include name="org.openscience.cdk.renderer.**.*"/>
                <include name="org.openscience.cdk.controller.**.*"/>
                <include name="org.openscience.cdk.libio.**.*"/>
              </patternset>
              </class>
              <class name="org.openscience.cdk.PeriodicTableElement" />
              <class name="org.openscience.cdk.renderer.selection.MultiSelection" />
              <class name="org.openscience.cdk.libio.cml.Convertor" methods="public" fields="none"/>
          </keep>
         </shrink>
      </yguard>

       <!-- shrink IO jar -->
       <yguard>
         <inoutpair in="${dist}/jar/jchempaint-applet-org_openscience_cdk_io.jar" out="${dist}/jar/shrinkout/jchempaint-applet-org_openscience_cdk_io.jar"/>
         <externalclasses>
             <fileset dir="${dist}/jar">
                <include name="**/*.jar"/>
                <exclude name="**/jchempaint-applet-org_openscience_cdk_io.jar"/>
             </fileset>
         </externalclasses>

         <shrink logfile="shrinklog.io.xml">
             <entrypointjar name="${dist}/jar/jchempaint-applet-core.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-editor.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-org_openscience_cdk.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-org_openscience.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-org_openscience_cdk_config.jar"/>
             <property name="error-checking" value="pedantic"/>
         </shrink>
      </yguard>


       <!-- shrink config jar>
       <yguard>
         <inoutpair in="${dist}/jar/jchempaint-applet-org_openscience_cdk_config.jar" out="${dist}/jar/shrinkout/jchempaint-applet-org_openscience_cdk_config.jar"/>
         <externalclasses>
             <fileset dir="${dist}/jar">
                <include name="**/*.jar"/>
                <exclude name="**/jchempaint-applet-org_openscience_cdk_config.jar"/>
             </fileset>
         </externalclasses>

         <shrink logfile="shrinklog.config.xml">
             <entrypointjar name="${dist}/jar/jchempaint-applet-core.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-editor.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-org_openscience_cdk.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-org_openscience.jar"/>
             <property name="error-checking" value="pedantic"/>
         </shrink>
      </yguard-->


       <!-- shrink tools jar -->
       <yguard>
         <inoutpair in="${dist}/jar/jchempaint-applet-org_openscience_cdk_tools.jar" out="${dist}/jar/shrinkout/jchempaint-applet-org_openscience_cdk_tools.jar"/>
         <externalclasses>
             <fileset dir="${dist}/jar">
                <include name="**/*.jar"/>
                <exclude name="**/jchempaint-applet-org_openscience_cdk_tools.jar"/>
             </fileset>
         </externalclasses>

         <shrink logfile="shrinklog.tools.xml">
             <entrypointjar name="${dist}/jar/jchempaint-applet-core.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-editor.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-org_openscience_cdk.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-org_openscience.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-org_openscience_cdk_io.jar"/>
             <property name="error-checking" value="pedantic"/>
             <keep>
                <class name="org.openscience.cdk.tools.manipulator.AtomContainerManipulator" methods="public" fields="none" />
             </keep>

         </shrink>
      </yguard>

       <!-- shrink xmlcml jar-->
       <yguard>
         <inoutpair in="${dist}/jar/jchempaint-applet-org_xmlcml.jar" out="${dist}/jar/shrinkout/jchempaint-applet-org_xmlcml.jar"/>
         <externalclasses>
             <fileset dir="${dist}/jar">
                <include name="**/*.jar"/>
             </fileset>
         </externalclasses>
         <shrink logfile="shrinklogcml.xml">
             <entrypointjar name="${dist}/jar/jchempaint-applet-core.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-editor.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-org_openscience_cdk.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-org_openscience.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-org_openscience_cdk_io.jar"/>
             <keep>
               <class name="org.xmlcml.cml.attribute.main.CountExpressionAttribute" />
               <class name="org.xmlcml.cml.base.StringArraySTAttribute" methods="private"  fields="private"/>
               <class classes="public" methods="private"  fields="private">
                 <patternset>
                   <include name="org.xmlcml.cml.attribute.*"/>
                </patternset>
                </class>
             </keep>
         </shrink>
      </yguard>

      <!-- shrink nu.xom jar -->
       <yguard>
         <inoutpair in="${dist}/jar/jchempaint-applet-nu.jar" out="${dist}/jar/shrinkout/jchempaint-applet-nu.jar"/>
         <externalclasses>
             <fileset dir="${dist}/jar">
                <include name="**/*.jar"/>
             </fileset>
         </externalclasses>
         <shrink logfile="shrinklog.nu.xml">
             <entrypointjar name="${dist}/jar/jchempaint-applet-core.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-editor.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-org_openscience_cdk.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-org_openscience_cdk_io.jar"/>
             <entrypointjar name="${dist}/jar/jchempaint-applet-org_xmlcml.jar"/>
             <property name="error-checking" value="pedantic"/>
             <keep>
               <class name="nu.xom.XPathContext"  methods="public" fields="none"/>
               <class name="nu.xom.Node"  methods="public" fields="none"/>
             </keep>
         </shrink>
      </yguard>

      <move todir="${dist}/jar">
       <fileset dir="${dist}/jar/shrinkout">
        <include name="**/*.jar"/>
       </fileset>
      </move>
      <delete dir="${dist}/jar/shrinkout"/>
      
      <signjar destDir=""
            alias="${certificatealias}"
            storepass="${keystorepassphrase}"
            preservelastmodified="true">
            <path>
                <fileset dir=".">
                    <includesfile name="${growing_classpath}"/>
                </fileset>
            </path>
      </signjar>
      
      <zip destfile="${dist}/jchempaint-applet-${jcp.version}.zip">
            <zipfileset dir="${dist}/jar" includes="jchempaint-applet-*.jar"/>
            <zipfileset dir="${cdk.dir}/doc" includes="lgpl.license"/>
            <zipfileset dir="." includes="lib-licenses.txt"/>
      </zip>
    </target>



    <target id="dist-applet" name="dist-applet" depends="build-applet" description="Builds the JChemPaint applet jar files with jarindex">
        <zip destfile="${dist}/jchempaint-applet-${jcp.version}.zip">
            <zipfileset dir="${dist}/jar" includes="jchempaint-applet-*.jar"/>
            <zipfileset dir="${cdk.dir}/doc" includes="lgpl.license"/>
            <zipfileset dir="." includes="lib-licenses.txt"/>
        </zip>
    </target>

    <target id="dist-applet-signed" name="dist-applet-signed" depends="build-applet" description="Builds the JChemPaint applet jar files with jarindex">
        <signjar destDir=""
            alias="${certificatealias}"
            storepass="${keystorepassphrase}"
            preservelastmodified="true">
            <path>
                <fileset dir=".">
                    <includesfile name="${growing_classpath}"/>
                </fileset>
            </path>
        </signjar>
        <zip destfile="${dist}/jchempaint-applet-${jcp.version}.zip">
            <zipfileset dir="${dist}/jar" includes="jchempaint-applet-*.jar"/>
            <zipfileset dir="${cdk.dir}/doc" includes="lgpl.license"/>
            <zipfileset dir="." includes="lib-licenses.txt"/>
        </zip>
    </target>
    
    
    <target id="build-applet" name="build-applet" depends="compile-jcp, unjar-libjars, unjar-cdkjars" description="Builds the JChemPaint applet jar files with jarindex">
        <manifest file="MANIFEST.MF">
            <attribute name="Built-By" value="${user.name}"/>
            <section name="common">
                <attribute name="Specification-Title" value="JChemPaint"/>
                <attribute name="Specification-Version" value="1.0"/>
                <attribute name="Specification-Vendor" value="The CDK Project"/>
                <attribute name="Implementation-Title" value="org.openscience.cdk"/>
                <attribute name="Implementation-Version" value="${jcp.version}"/>
                <attribute name="Implementation-Vendor" value="The CDK Project"/>
            </section>
        </manifest>
        <!-- At first jars are packed from file lists -->
        <!-- The file lists are generated from tomcat access log files with unpacked class files (and without jar files) -->
        <!-- cat apache/jakarta-tomcat-5.0.28/logs/localhost_access_log.2005-04-27.txt | awk -v classdir="/jcpapplet/classes/" '$9 != 404 && substr($7,0,length(classdir)) == classdir { print substr($7,length(classdir)+1) }' | sort -->
        <!-- hint: uncomment <Valve className="org.apache.catalina.valves.AccessLogValve" in conf/server.xml to switch on tomcat's access logging -->
        <concat destfile="${growing_list_file}" fixlastline="yes" append="yes">
            <fileset file="${metainf}/applet-core.files"/>
        </concat>
        <concat destfile="${growing_classpath}" fixlastline="no" append="no">${dist}/jar/jchempaint-applet-core.jar${line.separator}</concat>
        <macrodef name="jar-from-list">
            <attribute name="destfile"/>
            <attribute name="includesfile"/>
            <sequential>
                <jar destfile="@{destfile}" manifest="MANIFEST.MF">
                    <fileset dir="${dist-classes}">
                        <includesfile name="@{includesfile}"/>
                        <excludesfile name="${growing_list_file}"/>
                    </fileset>
                </jar>
                <concat destfile="${growing_list_file}" fixlastline="yes" append="yes"><fileset file="@{includesfile}" /></concat>
                <concat destfile="${growing_classpath}" fixlastline="no" append="yes">@{destfile}${line.separator}</concat>
            </sequential>
        </macrodef>
        <macrodef name="jar-from-pattern">
            <attribute name="destfile"/>
            <attribute name="includepattern"/>
            <sequential>
                <jar destfile="@{destfile}" manifest="MANIFEST.MF">
                    <fileset dir="${dist-classes}">
                        <include name="@{includepattern}"/>
                        <excludesfile name="${growing_list_file}"/>
                    </fileset>
                </jar>
                <concat destfile="${growing_list_file}" fixlastline="yes" append="yes">@{includepattern}${line.separator}</concat>
                <concat destfile="${growing_classpath}" fixlastline="no" append="yes">@{destfile}${line.separator}</concat>
            </sequential>
        </macrodef>

                <!--<echo message="Compiling applet logging tool org/openscience/cdk/tools/LoggingTool.java to ${dist-classes}"/>
                    <delete file="${dist-classes}/org/openscience/cdk/tools/LoggingTool.class"/>
                    <javac srcdir="applet" destdir="${dist-classes}" optimize="${optimization}" debug="${debug}" deprecation="${deprecation}" target="1.3" source="1.3">
                </javac>-->

        <mkdir dir="${dist}/jar" />
        <delete dir="${dist-classes}/org/openscience/jchempaint/resources/apponly"></delete>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-templates.jar" includepattern="org/openscience/jchempaint/dialog/templates/**"/>
        <jar-from-list destfile="${dist}/jar/jchempaint-applet-viewer-opts.jar" includesfile="${metainf}/applet-viewer-opts.files"/>
        <jar-from-list destfile="${dist}/jar/jchempaint-applet-editor.jar" includesfile="${metainf}/applet-editor.files"/>
        <jar-from-list destfile="${dist}/jar/jchempaint-applet-editor-opts.jar" includesfile="${metainf}/applet-editor-opts.files"/>
        <jar-from-list destfile="${dist}/jar/jchempaint-applet-resources.jar" includesfile="${metainf}/jchempaint.datafiles"/>
        <!-- the following jar files are packed from directory patterns -->
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_config.jar" includepattern="org/openscience/cdk/config/**"/>
        <!--jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_dict.jar" includepattern="org/openscience/cdk/dict/**"/-->
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_io_cml.jar" includepattern="org/openscience/cdk/io/cml/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_io.jar" includepattern="org/openscience/cdk/io/**"/>
        <!--jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_qsar.jar" includepattern="org/openscience/cdk/qsar/**"/-->
        <!--jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_iupac.jar" includepattern="org/openscience/cdk/iupac/**"/-->
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_math.jar" includepattern="org/openscience/cdk/math/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_tools.jar" includepattern="org/openscience/cdk/tools/**"/>
        <!--jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_structgen.jar" includepattern="org/openscience/cdk/structgen/**"/-->
        <!--jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_modeling.jar" includepattern="org/openscience/cdk/modeling/**"/-->
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk_controller.jar" includepattern="org/openscience/cdk/controller/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience_cdk.jar" includepattern="org/openscience/cdk/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_openscience.jar" includepattern="org/openscience/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_3pq.jar" includepattern="org/_3pq/**"/>
    <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_apache.jar" includepattern="org/apache/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_w3c.jar" includepattern="org/w3c/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_jaxen.jar" includepattern="org/jaxen/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org_xmlcml.jar" includepattern="org/xmlcml/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-org.jar" includepattern="org/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-com_ozten.jar" includepattern="com/ozten/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-Jama.jar" includepattern="Jama/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-jas.jar" includepattern="jas/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-javax_vecmath.jar" includepattern="javax/vecmath/**"/>
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-nu.jar" includepattern="nu/**"/>
        <!-- the following jar contains all other classes and resources -->
        <jar-from-pattern destfile="${dist}/jar/jchempaint-applet-others.jar" includepattern="**/*"/>
        <!-- the main jar file is packed from a list, but it must be packed as last file because it contains INDEX.LIST -->
        <jar destfile="${dist}/jar/jchempaint-applet-core.jar" index="true" manifest="MANIFEST.MF">
            <fileset dir="${dist-classes}">
                <includesfile name="${metainf}/applet-core.files"/>
            </fileset>
        </jar>
        <exec dir="${dist}/jar" executable="jar" >
             <arg line="i jchempaint-applet-core.jar jchempaint-applet-viewer-opts.jar jchempaint-applet-editor.jar jchempaint-applet-editor-opts.jar jchempaint-applet-resources.jar jchempaint-applet-org_openscience_cdk_config.jar jchempaint-applet-org_openscience_cdk_controller.jar jchempaint-applet-org_jaxen.jar jchempaint-applet-org_xmlcml.jar jchempaint-applet-org_openscience_cdk_io.jar jchempaint-applet-org_openscience_cdk_io_cml.jar jchempaint-applet-org_openscience_cdk_math.jar jchempaint-applet-org_openscience_cdk_tools.jar jchempaint-applet-org_openscience_cdk.jar jchempaint-applet-org_openscience.jar jchempaint-applet-org_3pq.jar jchempaint-applet-org_apache.jar jchempaint-applet-org_w3c.jar jchempaint-applet-org.jar jchempaint-applet-com_ozten.jar jchempaint-applet-Jama.jar jchempaint-applet-jas.jar jchempaint-applet-javax_vecmath.jar jchempaint-applet-nu.jar jchempaint-applet-templates.jar jchempaint-applet-others.jar" />
        </exec>
    </target>
    
    <target id="test-applet" name="test-applet">
        <mkdir dir="${dist-test}" />
        <javac srcdir="${src}/test" destdir="${dist-test}" optimize="${optimization}"
                nowarn="${nowarn}"
                debug="${debug}" deprecation="${deprecation}" target="1.5" source="1.5">
            <classpath>
                <fileset dir="${dist}/jar/">
                        <include name="*.jar" />
                </fileset>
                <fileset dir="${lib}">
                        <include name="*.jar" />
                </fileset>
                <fileset dir="${cdk.devellib}">
                        <include name="*.jar" />
                </fileset>
                <fileset dir="${devellib}">
                        <include name="*.jar" />
                </fileset>
            </classpath>
        </javac>
        <copy todir="${dist-test}/data">
            <fileset dir="${src}/test/data"/>
        </copy>
        <junit forkmode="perBatch" printsummary="yes" haltonfailure="no" haltonerror="no">
            <classpath>
                <fileset dir="${dist}/jar/">
                        <include name="*.jar" />
                </fileset>
                <fileset dir="${lib}">
                        <include name="*.jar" />
                </fileset>
                <fileset dir="${cdk.devellib}">
                        <include name="*.jar" />
                </fileset>
                <fileset dir="${devellib}">
                        <include name="*.jar" />
                </fileset>
                <pathelement location="${dist-test}"/>
            </classpath>
            <test name="org.openscience.jchempaint.AllJCPTests"
                haltonfailure="no">
                <formatter type="brief" />
            </test>
        </junit>
    </target>

    <target id="dist-jars" name="dist-jars" depends="compile-jcp">
        <mkdir dir="${dist}/alljars" />
        <copy todir="${dist}/alljars">
            <fileset dir="${cdk.dist}/jar">
              <include name="*.jar" />
            </fileset>
        </copy>
        <jar jarfile="${dist}/alljars/cdk-jchempaint.jar">
            <fileset dir="${dist-classes}">
                <include name="org/openscience/jchempaint/**/*" />
            </fileset>
        </jar>
        <copy todir="${dist}/alljars">
            <fileset dir="${cdk.lib}">
              <include name="*.jar" />
            </fileset>
        </copy>
        <copy todir="${dist}/alljars">
            <fileset dir="${lib}">
              <include name="*.jar" />
            </fileset>
        </copy>
        <zip destfile="${dist}/jchempaint-lib-${jcp.version}.zip">
              <zipfileset dir="${dist}/alljars" includes="*.jar"/>
        </zip>
    </target>
    
    <target name="javadoc" depends="build-applet">
        <mkdir dir="${javadoc.dir}" />
        <javac srcdir="${src}/util" destdir="${javadoc.dir}" optimize="${optimization}"
                nowarn="${nowarn}"
                debug="${debug}" deprecation="${deprecation}" target="1.5" source="1.5">
            <classpath>
                <fileset dir="${cdk.lib}" >
                </fileset>
                <fileset dir="${cdk.devellib}">
                </fileset>
                <fileset dir="${cdk.dist}/jar">
                </fileset>
                <fileset dir="${lib}">
                </fileset>
                <pathelement location="${dist-classes}"/>
            </classpath>
            <include name="**/JCPParamsTaglet.java"/>
        </javac>
        <javadoc destdir="${javadoc.dir}"
                 author="true" version="true" use="true"
                 public="true"
                 windowtitle="JChemPaint API">
            <classpath>
                <fileset dir="${cdk.lib}" >
                </fileset>
                <fileset dir="${cdk.devellib}">
                </fileset>
                <fileset dir="${cdk.dist}/jar">
                </fileset>
                <fileset dir="${lib}">
                </fileset>
            </classpath>
            <taglet name="JCPParamsTaglet" path="${cdk.lib}/jar/xom-1.1.jar:${javadoc.dir}:${dist-classes}" />
            <packageset dir="${src}/main" defaultexcludes="yes">
                <include name="org/openscience/jchempaint/**" />
            </packageset>
        </javadoc>
    </target>
       
    <target name="makelicenseinfo">
        <mkdir dir="${dist}"/>
        <javac srcdir="${src}/util" destdir="${dist}" optimize="${optimization}"
                nowarn="${nowarn}"
                debug="${debug}" deprecation="${deprecation}" target="1.5" source="1.5">
            <classpath>
                <fileset dir="${cdk.lib}" >
                </fileset>
                <fileset dir="${cdk.devellib}">
                </fileset>
                <fileset dir="${cdk.dist}/jar">
                </fileset>
                <fileset dir="${lib}">
                </fileset>
                <pathelement location="${dist-classes}"/>
            </classpath>
            <include name="**/ExtractCoprightInfo.java"/>
        </javac>
        <java classname="ExtractCoprightInfo" classpath="${dist}">
            <arg value="${cdk.lib}"/>
        </java>
        <delete file="${dist}/ExtractCoprightInfo.class"></delete>
    </target>
           
    <target name="processTemplates">
        <mkdir dir="${dist}"/>
        <javac srcdir="${src}/util" destdir="${dist}" optimize="${optimization}"
                nowarn="${nowarn}"
                debug="${debug}" deprecation="${deprecation}" target="1.5" source="1.5">
            <classpath>
                <fileset dir="${cdk.lib}" >
                </fileset>
                <fileset dir="libutil" >
                </fileset>
                <fileset dir="${cdk.devellib}">
                </fileset>
                <fileset dir="${cdk.dist}/jar">
                </fileset>
                <fileset dir="${lib}">
                </fileset>
                <pathelement location="${dist-classes}"/>
            </classpath>
            <include name="**/TemplateImagesMaker.java"/>
        </javac>
        <java classname="TemplateImagesMaker" fork="true">
            <classpath>
                <fileset dir="${cdk.lib}" >
                </fileset>
                <fileset dir="libutil" >
                </fileset>
                <fileset dir="${cdk.devellib}">
                </fileset>
                <fileset dir="${cdk.dist}/jar">
                </fileset>
                <fileset dir="${lib}">
                </fileset>
                <pathelement location="${dist-classes}"/>
                <pathelement location="${dist}"/>
            </classpath>
        </java>
        <delete file="${dist}/TemplateImagesMaker.class"></delete>      
    </target>
    
    <target name="generateHelp">
        <mkdir dir="${dist}"/>
        <javac srcdir="${src}/util" destdir="${dist}" optimize="${optimization}"
                nowarn="${nowarn}"
                debug="${debug}" deprecation="${deprecation}" target="1.5" source="1.5">
            <classpath>
                <fileset dir="libutil" >
                    <include name="html.jar"/>
                </fileset>
                <pathelement location="${dist-classes}"/>
            </classpath>
            <include name="**/HtmlExample.java"/>
        </javac>
        <java classname="HtmlExample" fork="true">
            <classpath>
                <fileset dir="libutil" >
                    <include name="html.jar"/>
                </fileset>
                <fileset dir="${cdk.dist}/jar"/>
                <pathelement location="${dist-classes}"/>
                <pathelement location="${dist}"/>
            </classpath>
        </java>
        <delete file="${dist}/HtmlExample.class"></delete>
    </target>
</project>



